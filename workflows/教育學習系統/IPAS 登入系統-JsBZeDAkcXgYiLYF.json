{
  "updatedAt": "2026-01-02T17:39:21.773Z",
  "createdAt": "2025-10-02T05:11:58.384Z",
  "id": "JsBZeDAkcXgYiLYF",
  "name": "IPAS ç™»å…¥ç³»çµ±",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "check-member-status",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -928,
        -1584
      ],
      "id": "c6065b50-c58d-4e5c-af52-31c2508dbe2f",
      "name": "Webhook1",
      "webhookId": "[REMOVED]"
    },
    {
      "parameters": {
        "jsCode": "// å–å¾—è¦æŸ¥è©¢çš„ Line User ID\nconst requestData = $input.first().json;\nconst userIdToCheck = $input.first().json.body.userId;\n\nif (!userIdToCheck) {\n  return [{\n    json: {\n      status: 'error',\n      message: 'ç¼ºå°‘ userId'\n    }\n  }];\n}\n\n// æº–å‚™æŸ¥è©¢æ¢ä»¶\nreturn [{\n  json: {\n    searchUserId: userIdToCheck\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        -1584
      ],
      "id": "dd3a82cd-ddde-4b82-94b4-b802b0fc2784",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g",
          "mode": "list",
          "cachedResultName": "ç¤¾ç¾¤iPAS é¡Œåº«",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 513684577,
          "mode": "list",
          "cachedResultName": "æœƒå“¡è³‡æ–™",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g/edit#gid=513684577"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "line_user_id",
              "lookupValue": "={{ $json.searchUserId }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -480,
        -1584
      ],
      "id": "29b824cc-37f7-465f-8a0e-fd200e4442ba",
      "name": "Get row(s) in sheet",
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "jsCode": "const sheetResults = $input.first().json;\n\n// --- ä¿®æ­£é–‹å§‹ ---\n// 1. æª¢æŸ¥ sheetResults æ˜¯å¦ç‚º null/undefined\n// 2. æª¢æŸ¥ sheetResults æ˜¯å¦ç‚ºç©ºé™£åˆ—\nif (!sheetResults || (Array.isArray(sheetResults) && sheetResults.length === 0)) {\n  return [{\n    json: {\n      status: 'not_found',\n      memberLevel: 'å…è²»æœƒå“¡', // é€™è£¡æ‡‰ç‚º 'å…è²»æœƒå“¡' è€Œä¸æ˜¯ 'æœƒå“¡'\n      isPaid: false\n    }\n  }];\n}\n\n// ç¢ºä¿ userData ç¸½æ˜¯å¾é™£åˆ—ä¸­å–å¾—ç¬¬ä¸€å€‹æœ‰æ•ˆçš„ç‰©ä»¶\nconst userData = Array.isArray(sheetResults) ? sheetResults[0] : sheetResults;\n\n// ç”±æ–¼ Google Sheets ç¯€é»é€šå¸¸å›å‚³é™£åˆ—ï¼Œä½†ä»¥é˜²è¬ä¸€ï¼Œæˆ‘å€‘ä¹Ÿæª¢æŸ¥ userData æ˜¯å¦ç‚º undefined\nif (!userData) {\n    return [{\n        json: {\n            status: 'error_data',\n            memberLevel: 'å…è²»æœƒå“¡',\n            isPaid: false\n        }\n    }];\n}\n// --- ä¿®æ­£çµæŸ ---\n\n\nconst isPaid = userData.member_level === 'æœƒå“¡' || userData.member_level === 'ä»˜è²»æœƒå“¡'; // é€™è£¡å¯èƒ½éœ€è¦æ ¹æ“šæ‚¨çš„ Sheets æ¬„ä½èª¿æ•´\n\nreturn [{\n  json: {\n    status: 'found',\n    memberLevel: userData.member_level,\n    isPaid: isPaid,\n    userId: userData.line_user_id,\n    displayName: userData.display_name\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -256,
        -1584
      ],
      "id": "2d597ae8-f835-4faf-85eb-bab253050199",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"{{ $('Code in JavaScript1').first().json.status }}\",\n  \"memberLevel\": \"{{ $('Code in JavaScript1').first().json.memberLevel }}\",\n  \"isPaid\": \"{{ $('Code in JavaScript1').first().json.isPaid }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -32,
        -1584
      ],
      "id": "9cd718a5-0286-433a-94e6-af4e7ba3c5bb",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-login",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -928,
        -1264
      ],
      "id": "1f3da55d-8b04-42b4-b82c-f44e1afd3665",
      "name": "æ¥æ”¶ Webhook",
      "webhookId": "[REMOVED]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-options",
              "leftValue": "={{ $json.method }}",
              "rightValue": "OPTIONS",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -704,
        -1264
      ],
      "id": "b43764f0-6aba-4195-8caf-7e59f3508364",
      "name": "æª¢æŸ¥æ˜¯å¦ç‚º OPTIONS"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -480,
        -1360
      ],
      "id": "ecf49f5c-f692-4b1d-b862-f13c35f839de",
      "name": "å›æ‡‰ OPTIONS (CORS Preflight)"
    },
    {
      "parameters": {
        "url": "https://api.line.me/v2/profile",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -256,
        -1168
      ],
      "id": "065f7ece-025f-40a0-8c06-9670c4cf811e",
      "name": "å–å¾—ç”¨æˆ¶è³‡æ–™"
    },
    {
      "parameters": {
        "jsCode": "// å¾ Line Login å–å¾—ç”¨æˆ¶è³‡æ–™\nconst userData = $input.first().json;\n\n// æª¢æŸ¥å¿…è¦æ¬„ä½\nif (!userData.userId) {\n  throw new Error('ç¼ºå°‘ Line User ID');\n}\n\n// æº–å‚™æœƒå“¡è³‡æ–™\nconst memberData = {\n  line_user_id: userData.userId,\n  displayName: userData.displayName || 'æœªçŸ¥ç”¨æˆ¶',\n  email: userData.email || '',\n  member_level: 'æœƒå“¡',\n  paid_until: '',\n  register_date: new Date().toISOString().split('T')[0],\n  pictureUrl: userData.pictureUrl || ''\n};\n\n// è¨˜éŒ„è£½ä½œè€…è³‡è¨Š\nconsole.log('Workflow by Nick Chang | nickleo051216@gmail.com');\n\nreturn [{\n  json: memberData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -32,
        -1168
      ],
      "id": "442ec6ea-1544-4081-bd11-0fd855750f87",
      "name": "è™•ç†ç”¨æˆ¶è³‡æ–™"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g",
          "mode": "list",
          "cachedResultName": "ç¤¾ç¾¤iPAS é¡Œåº«",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 513684577,
          "mode": "list",
          "cachedResultName": "æœƒå“¡è³‡æ–™",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g/edit#gid=513684577"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "line_user_id": "={{ $json.line_user_id }}",
            "member_level": "={{ $json.member_level }}",
            "paid_until": "={{ $json.paid_until }}",
            "register_date": "={{ $json.register_date }}",
            "displayName": "={{ $json.displayName }}",
            "pictureUrl": "={{ $json.pictureUrl }}",
            "last_login": "={{ $now }}"
          },
          "matchingColumns": [
            "line_user_id"
          ],
          "schema": [
            {
              "id": "line_user_id",
              "displayName": "line_user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "displayName",
              "displayName": "displayName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "member_level",
              "displayName": "member_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paid_until",
              "displayName": "paid_until",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pictureUrl",
              "displayName": "pictureUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "register_date",
              "displayName": "register_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_login",
              "displayName": "last_login",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        192,
        -1072
      ],
      "id": "c256fdbf-e12f-4334-afec-b0be14ffdd9e",
      "name": "å„²å­˜åˆ° Google Sheets",
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-member-level",
              "leftValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.member_level }}",
              "rightValue": "ä»˜è²»æœƒå“¡",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        416,
        -1072
      ],
      "id": "25ec2319-df10-4a9d-9028-a78573028cd0",
      "name": "æª¢æŸ¥æœƒå“¡ç­‰ç´š"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"æœƒå“¡ç™»å…¥æˆåŠŸ\",\n  \"needPayment\": false,\n  \"user\": {\n    \"userId\": \"{{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.line_user_id }}\",\n    \"displayName\": \"{{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.displayName }}\",\n    \"memberLevel\": \"{{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.member_level }}\",\n    \"pictureUrl\": \"{{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.pictureUrl }}\"\n  },\n  \"creator\": {\n    \"name\": \"Nick Chang\",\n    \"email\": \"nickleo051216@gmail.com\",\n    \"phone\": \"0932-684-051\",\n    \"website\": \"https://portaly.cc/zn.studio\"\n  }\n}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        640,
        -1120
      ],
      "id": "bf38fd25-a677-4d8b-b390-8e2ebe4b2732",
      "name": "å›æ‡‰ï¼šä»˜è²»æœƒå“¡"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"æœƒå“¡è¨»å†ŠæˆåŠŸï¼Œè«‹å‡ç´šç‚ºä»˜è²»æœƒå“¡\",\n  \"needPayment\": true,\n  \"paymentUrl\": \"https://portaly.cc/zn.studio\",\n  \"user\": {\n    \"userId\": \"{{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.line_user_id }}\",\n    \"displayName\": \"{{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.displayName }}\",\n    \"memberLevel\": \"{{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.member_level }}\",\n    \"pictureUrl\": \"{{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').first().json.pictureUrl }}\"\n  },\n  \"creator\": {\n    \"name\": \"Nick Chang\",\n    \"email\": \"nickleo051216@gmail.com\",\n    \"phone\": \"0932-684-051\",\n    \"website\": \"https://portaly.cc/zn.studio\"\n  }\n}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        640,
        -976
      ],
      "id": "262e31e5-00f1-4b77-9ba8-0873119d967b",
      "name": "å›æ‡‰ï¼šä¸€èˆ¬æœƒå“¡ï¼ˆéœ€ä»˜è²»ï¼‰"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/oauth2/v2.1/token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "grant_type",
              "value": "authorization_code"
            },
            {
              "name": "code",
              "value": "={{ $json.body.code }}"
            },
            {
              "name": "redirect_uri",
              "value": "https://nickleo9.github.io/GenAI/login-callback.html"
            },
            {
              "name": "client_id",
              "value": "2008218944"
            },
            {
              "name": "client_secret",
              "value": "7b1c0a3d05b2acfd91cc77329bbf9f15"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -480,
        -1168
      ],
      "id": "4d925c19-891c-4efb-bd8d-4234b2a18cbe",
      "name": "å…Œæ› Access Token1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "save-practice-record",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "545b897e-ced4-4013-b138-7e7fbae1ffdc",
      "name": "æ¥æ”¶å‰ç«¯è«‹æ±‚",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -928,
        -656
      ],
      "webhookId": "[REMOVED]"
    },
    {
      "parameters": {
        "jsCode": "// è£½ä½œè€…: Nick Chang | nickleo051216@gmail.com\n// åŠŸèƒ½: è™•ç†å‰ç«¯é€ä¾†çš„ç·´ç¿’è¨˜éŒ„è³‡æ–™\n\nconst inputData = $input.first().json.body;\n\n// æª¢æŸ¥å¿…è¦æ¬„ä½\nif (!inputData.userId) {\n  throw new Error('ç¼ºå°‘ userId');\n}\n\nif (!inputData.databaseType) {\n  throw new Error('ç¼ºå°‘ databaseType');\n}\n\n// è¨ˆç®—æ­£ç¢ºç‡\nconst accuracy = inputData.questionCount > 0 \n  ? (inputData.score / inputData.questionCount * 100).toFixed(2)\n  : 0;\n\n// æº–å‚™è¦å„²å­˜çš„è³‡æ–™\nconst practiceRecord = {\n  user_id: inputData.userId,\n  database_type: inputData.databaseType,\n  question_count: inputData.questionCount || 0,\n  start_time: inputData.startTime || new Date().toISOString(),\n  end_time: inputData.endTime || new Date().toISOString(),\n  score: inputData.score || 0,\n  accuracy: parseFloat(accuracy),\n  // æ ¸å¿ƒï¼šç›´æ¥å°‡å‰ç«¯å‚³ä¾†çš„ answers é™£åˆ—å„²å­˜åˆ° JSONB æ¬„ä½\n  answers: inputData.answers || [], \n  marked_questions: inputData.markedQuestions || []\n};\n\nconsole.log('âœ… ç·´ç¿’è¨˜éŒ„è³‡æ–™å·²æº–å‚™:', practiceRecord);\n\nreturn [{\n  json: practiceRecord\n}];"
      },
      "id": "5f63f2ca-2de2-4d75-982e-c7123d50f227",
      "name": "è™•ç†è³‡æ–™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        -656
      ]
    },
    {
      "parameters": {
        "tableId": "practice_records",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "score",
              "fieldValue": "={{ $json.score }}"
            },
            {
              "fieldId": "database_type",
              "fieldValue": "={{ $json.database_type }}"
            },
            {
              "fieldId": "accuracy",
              "fieldValue": "={{ $json.accuracy }}"
            },
            {
              "fieldId": "end_time",
              "fieldValue": "={{ $json.end_time }}"
            },
            {
              "fieldId": "start_time",
              "fieldValue": "={{ $json.start_time }}"
            },
            {
              "fieldId": "question_count",
              "fieldValue": "={{ $json.question_count }}"
            },
            {
              "fieldId": "answers",
              "fieldValue": "={{ $json.answers }}"
            }
          ]
        }
      },
      "id": "5585d4d7-d681-488c-8498-e0b007772b9f",
      "name": "å„²å­˜åˆ° practice_records",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -480,
        -656
      ],
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "jsCode": "// è£½ä½œè€…: Nick Chang | nickleo051216@gmail.com\n// åŠŸèƒ½: æº–å‚™æ›´æ–°æ¯æ—¥ä½¿ç”¨é‡è³‡æ–™\n\nconst practiceData = $input.first().json;\nconst userId = practiceData.user_id;\nconst today = new Date().toISOString().split('T')[0];\n\n// æº–å‚™æŸ¥è©¢æ¢ä»¶\nconst queryData = {\n  user_id: userId,\n  usage_date: today\n};\n\nconsole.log('ğŸ” æŸ¥è©¢ä»Šæ—¥ä½¿ç”¨é‡:', queryData);\n\nreturn [{\n  json: queryData\n}];"
      },
      "id": "709b0bee-ffd5-4e68-beb4-3934d20f810c",
      "name": "æº–å‚™æŸ¥è©¢æ¢ä»¶",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -256,
        -656
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "daily_usage",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        }
      },
      "id": "c68baed4-b33a-467d-8ad2-b631ab98e17c",
      "name": "æŸ¥è©¢ä»Šæ—¥ä½¿ç”¨é‡",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -32,
        -656
      ],
      "alwaysOutputData": true,
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "check-exists",
              "leftValue": "={{ $json.user_id }}",
              "rightValue": 0,
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3fc5ad71-2146-45e8-bec4-4933d00a93a5",
      "name": "åˆ¤æ–·æ˜¯å¦æœ‰è¨˜éŒ„",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        192,
        -656
      ]
    },
    {
      "parameters": {
        "jsCode": "// è£½ä½œè€…: Nick Chang | nickleo051216@gmail.com\n// åŠŸèƒ½: æ›´æ–°ç¾æœ‰çš„æ¯æ—¥ä½¿ç”¨é‡è¨˜éŒ„\n\nconst existingRecord = $input.first().json[0];\nconst practiceData = $('å„²å­˜åˆ° practice_records').first().json;\n\n// å¢åŠ ç·´ç¿’æ¬¡æ•¸å’Œç­”é¡Œç¸½æ•¸\nconst updatedData = {\n  usage_id: $input.first().json.usage_id,\n  practice_count: ($input.first().json.practice_count || 0) + 1,\n  total_questions_answered: ($input.first().json.total_questions_answered || 0) + $input.first().json.question_count\n};\n\nconsole.log('ğŸ“ æ›´æ–°æ¯æ—¥ä½¿ç”¨é‡:', updatedData);\n\nreturn [{\n  json: updatedData\n}];"
      },
      "id": "593a628e-4bc8-4c27-82fb-fc2a1c60d864",
      "name": "æº–å‚™æ›´æ–°è³‡æ–™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        -752
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "daily_usage",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "usage_id",
              "condition": "eq",
              "keyValue": "={{ $json.usage_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "practice_count",
              "fieldValue": "={{ $json.practice_count }}"
            }
          ]
        }
      },
      "id": "fb80e80d-0465-4937-a16e-6d18bb8d992d",
      "name": "æ›´æ–°æ¯æ—¥ä½¿ç”¨é‡",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        640,
        -752
      ],
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "jsCode": "// è£½ä½œè€…: Nick Chang | nickleo051216@gmail.com\n// åŠŸèƒ½: å»ºç«‹æ–°çš„æ¯æ—¥ä½¿ç”¨é‡è¨˜éŒ„\n\nconst queryData = $('æº–å‚™æŸ¥è©¢æ¢ä»¶').first().json;\nconst practiceData = $('å„²å­˜åˆ° practice_records').first().json;\n\nconst newUsageRecord = {\n  user_id: queryData.user_id,\n  usage_date: queryData.usage_date,\n  practice_count: 1,\n  exam_count: 0,\n  review_count: 0,\n  total_questions_answered: practiceData.question_count\n};\n\nconsole.log('âœ¨ å»ºç«‹æ–°çš„æ¯æ—¥ä½¿ç”¨é‡è¨˜éŒ„:', newUsageRecord);\n\nreturn [{\n  json: newUsageRecord\n}];"
      },
      "id": "a5376872-cc72-46eb-a8b0-b5d42f2b8f1f",
      "name": "æº–å‚™æ–°å¢è³‡æ–™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        -560
      ]
    },
    {
      "parameters": {
        "tableId": "daily_usage",
        "dataToSend": "autoMapInputData"
      },
      "id": "8f28782e-972c-43c3-be5e-ef15e9c27bb3",
      "name": "æ–°å¢æ¯æ—¥ä½¿ç”¨é‡",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        640,
        -560
      ],
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"ç·´ç¿’è¨˜éŒ„å·²å„²å­˜\",\n  \"data\": {\n    \"recordId\": \"{{ $('å„²å­˜åˆ° practice_records').first().json.record_id }}\",\n    \"userId\": \"{{ $('å„²å­˜åˆ° practice_records').first().json.user_id }}\",\n    \"score\": \"{{ $('å„²å­˜åˆ° practice_records').first().json.score }}\",\n    \"accuracy\": \"{{ $('å„²å­˜åˆ° practice_records').first().json.accuracy }}\",\n    \"savedAt\": \"{{ $now.toISO() }}\"\n  },\n  \"creator\": \"Nick Chang | nickleo051216@gmail.com\"\n}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "ebf0cf94-f65f-4e04-93bd-4e9a0eca221c",
      "name": "å›å‚³æˆåŠŸè¨Šæ¯",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        864,
        -656
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "users",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $json.line_user_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        192,
        -1360
      ],
      "id": "bd40f96d-0fe6-4d20-a02f-f02d7edc5633",
      "name": "Get a row",
      "alwaysOutputData": true,
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "27a00b99-1f0f-4e7d-9389-c1f20d77a7c9",
              "leftValue": "={{ $items(\"Get a row\").length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        416,
        -1360
      ],
      "id": "405cab77-e8cd-460f-919d-ed92a323ef17",
      "name": "If",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "content": "é¡Œç›®åŒæ­¥é›²ç«¯",
        "height": 560,
        "width": 2176
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1184,
        -912
      ],
      "typeVersion": 1,
      "id": "91c0a79c-6cfc-4a46-8f48-abad96018e49",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// åŠŸèƒ½ï¼šè™•ç†ç­”é¡Œè¨˜éŒ„ï¼Œç²¾æº–æ‰¾å‡ºç­”éŒ¯çš„é¡Œç›® (å…¼å®¹ Object/Array)\nconst inputData = $input.first().json.body;\nconst answers = inputData.answers;\nconst questions = inputData.questions;\nconst wrongQuestions = [];\n\n// çµ±ä¸€è™•ç† Object æˆ– Array\nconst keys = Object.keys(answers);\n\nkeys.forEach(index => {\n  const answer = answers[index];\n  const question = questions[index];\n  \n  if (question) {\n    // å„ªå…ˆä½¿ç”¨å‰ç«¯å‚³ä¾†çš„ isCorrect æ¨™è¨˜ï¼Œè‹¥ç„¡å‰‡æ¯”å° originalIndex\n    // é€™æ¨£å¯ä»¥é¿å…å› ç‚ºé¸é …æ‰“äº‚å°è‡´å¾Œç«¯åˆ¤æ–·éŒ¯èª¤\n    const isUserCorrect = (answer.isCorrect !== undefined) \n      ? answer.isCorrect \n      : (answer.originalIndex === question.correct_answer_index);\n\n    if (!isUserCorrect) {\n      wrongQuestions.push({\n        user_id: inputData.userId,\n        question_id: question.question_id || `Q${parseInt(index) + 1}`,\n        database_type: inputData.databaseType || 'ipas',\n        topic: question.topic || 'æœªåˆ†é¡',\n        subtopic: question.subtopic || 'æœªåˆ†é¡',\n        question_text: question.question,\n        correct_answer: question.correct_answer_letter, // é€™è£¡æœƒæ˜¯æ‰“äº‚å¾Œæ­£ç¢ºçš„å­—æ¯\n        user_answer: answer.answer,\n        answered_at: answer.timestamp || new Date().toISOString()\n      });\n    }\n  }\n});\n\nreturn wrongQuestions.map(q => ({ json: q }));"
      },
      "id": "fe8dd915-6593-4188-ad30-0112c78d02ed",
      "name": "æ‰¾å‡ºç­”éŒ¯çš„é¡Œç›®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        -288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-no-wrong",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": "={{ 0 }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "122f6ee1-ab60-49c5-81db-68b6c55dd1a4",
      "name": "åˆ¤æ–·: æ˜¯å¦æœ‰éŒ¯é¡Œ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -480,
        -288
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"å…¨éƒ¨ç­”å°,æ²’æœ‰éŒ¯é¡Œéœ€è¦è¨˜éŒ„ ğŸ‰\",\n  \"data\": {\n    \"userId\": \"{{ $json.userId }}\",\n    \"wrongCount\": 0\n  }",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "e899a043-129f-4dac-8df1-ac00be6183ce",
      "name": "å›æ‡‰: æ²’æœ‰éŒ¯é¡Œ",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -256,
        -384
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "wrong_questions",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $json.user_id }}"
            },
            {
              "keyName": "question_id",
              "keyValue": "={{ $json.question_id }}"
            }
          ]
        }
      },
      "id": "45b6cc7d-ddfb-4e2c-8105-8b912198d8f0",
      "name": "æŸ¥è©¢è©²éŒ¯é¡Œæ˜¯å¦å·²å­˜åœ¨",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -32,
        -224
      ],
      "alwaysOutputData": true,
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-array-length",
              "leftValue": "={{ $json.wrong_id }}",
              "rightValue": 0,
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0330b53e-d549-474f-965c-e68d577a3f8c",
      "name": "åˆ¤æ–·: éŒ¯é¡Œæ˜¯å¦å·²å­˜åœ¨?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        160,
        -224
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "wrong_questions",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "wrong_id",
              "condition": "eq",
              "keyValue": "={{ $json.wrong_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "wrong_count",
              "fieldValue": "={{ $json.wrong_count }}"
            },
            {
              "fieldId": "last_wrong_date",
              "fieldValue": "={{ $json.last_wrong_date }}"
            },
            {
              "fieldId": "user_answers",
              "fieldValue": "={{ JSON.stringify($json.user_answers) }}"
            },
            {
              "fieldId": "is_reviewed",
              "fieldValue": "={{ $json.is_reviewed }}"
            }
          ]
        }
      },
      "id": "93eef7e6-9288-4ad4-a3cc-5d2bcbeff0f6",
      "name": "æ›´æ–°ç¾æœ‰éŒ¯é¡Œ",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        640,
        -64
      ],
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "tableId": "wrong_questions",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "question_id",
              "fieldValue": "={{ $('Loop Over Items').item.json.question_id }}"
            },
            {
              "fieldId": "database_type",
              "fieldValue": "={{ $('Loop Over Items').item.json.database_type }}"
            },
            {
              "fieldId": "topic",
              "fieldValue": "={{ $('Loop Over Items').item.json.topic }}"
            },
            {
              "fieldId": "subtopic",
              "fieldValue": "={{ $('Loop Over Items').item.json.subtopic }}"
            },
            {
              "fieldId": "wrong_count",
              "fieldValue": "={{ $json.wrong_count }}"
            },
            {
              "fieldId": "first_wrong_date",
              "fieldValue": "={{ $json.first_wrong_date }}"
            },
            {
              "fieldId": "last_wrong_date",
              "fieldValue": "={{ $json.last_wrong_date }}"
            },
            {
              "fieldId": "is_reviewed",
              "fieldValue": "={{ $json.is_reviewed }}"
            },
            {
              "fieldId": "user_answers",
              "fieldValue": "={{ $('Loop Over Items').item.json.user_answer }}"
            },
            {
              "fieldId": "question",
              "fieldValue": "={{ $('Loop Over Items').item.json.question_text }}"
            },
            {
              "fieldId": "correct_answer",
              "fieldValue": "={{ $('Loop Over Items').item.json.correct_answer }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Loop Over Items').item.json.user_id }}"
            }
          ]
        }
      },
      "id": "e7eb1e59-a53d-4b70-aec4-efd7aaf7ff79",
      "name": "æ–°å¢éŒ¯é¡Œè¨˜éŒ„",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        640,
        -272
      ],
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "jsCode": "// åŠŸèƒ½ï¼šæº–å‚™æ›´æ–°ç¾æœ‰éŒ¯é¡Œï¼Œä¸¦ç¢ºä¿ ID å­˜åœ¨\nconst wrongQuestionData = $json;\nlet existingRecord = $('æŸ¥è©¢è©²éŒ¯é¡Œæ˜¯å¦å·²å­˜åœ¨').first().json;\n\n// è™•ç† Supabase å›å‚³é™£åˆ—çš„æƒ…æ³\nif (Array.isArray(existingRecord)) {\n    existingRecord = existingRecord[0];\n}\n\n// é—œéµé˜²å‘†ï¼šå¦‚æœçœŸçš„æŠ“ä¸åˆ° IDï¼Œå°±å›å‚³ç©º\nif (!existingRecord || !existingRecord.wrong_id) {\n    return [];\n}\n\n// ğŸ”¥ ä¿®æ­£ï¼šè™•ç†èˆŠçš„ç­”æ¡ˆç´€éŒ„ (ç¢ºä¿ä¸€å®šæ˜¯é™£åˆ—)\nlet userAnswers = [];\ntry {\n  if (existingRecord.user_answers) {\n    const parsed = typeof existingRecord.user_answers === 'string' \n      ? JSON.parse(existingRecord.user_answers) \n      : existingRecord.user_answers;\n    \n    // é—œéµä¿®æ­£ï¼šç¢ºä¿ä¸€å®šæ˜¯é™£åˆ—\n    if (Array.isArray(parsed)) {\n      userAnswers = parsed;\n    } else if (typeof parsed === 'object' && parsed !== null) {\n      // å¦‚æœæ˜¯ç‰©ä»¶ï¼Œè½‰æ›æˆé™£åˆ—\n      userAnswers = Object.values(parsed);\n    }\n  }\n} catch (e) {\n  userAnswers = [];\n}\n\n// åŠ å…¥æœ¬æ¬¡æ–°çš„éŒ¯èª¤ç­”æ¡ˆ\nuserAnswers.push({\n  answer: wrongQuestionData.user_answer,\n  timestamp: wrongQuestionData.answered_at\n});\n\nreturn [{\n  json: {\n    wrong_id: existingRecord.wrong_id,\n    wrong_count: (existingRecord.wrong_count || 0) + 1,\n    last_wrong_date: new Date().toISOString(),\n    user_answers: JSON.stringify(userAnswers),\n    is_reviewed: false\n  }\n}];"
      },
      "id": "37f0a1fb-4981-4bea-906b-f85f427969fe",
      "name": "æº–å‚™æ›´æ–°è³‡æ–™1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        -64
      ]
    },
    {
      "parameters": {
        "jsCode": "// åŠŸèƒ½ï¼šæº–å‚™æ–°å¢ã€Œç¬¬ä¸€æ¬¡ç­”éŒ¯ã€çš„è³‡æ–™\n// æŠ“å–ç•¶å‰ Loop æ­£åœ¨è™•ç†çš„é¡Œç›®è³‡æ–™\n// æ³¨æ„ï¼šè«‹ç¢ºä¿ä½ çš„ Loop ç¯€é»åç¨±çœŸçš„æ˜¯ 'Loop Over Items'ï¼Œå¦‚æœä¸æ˜¯è«‹ä¿®æ”¹ä¸‹é¢é€™è¡Œ\nconst wrongQuestionData = $('Loop Over Items').item.json;\n\n// 1. åˆå§‹åŒ– user_answers é™£åˆ—ï¼Œæ”¾å…¥é€™ä¸€æ¬¡çš„éŒ¯èª¤ç­”æ¡ˆ\nconst userAnswers = [{\n  answer: wrongQuestionData.user_answer,\n  timestamp: wrongQuestionData.answered_at || new Date().toISOString()\n}];\n\n// 2. æº–å‚™è¦å¯«å…¥è³‡æ–™åº«çš„æ–°è³‡æ–™\n// é€™è£¡ä¸éœ€è¦æŒ‡å®š wrong_idï¼Œå› ç‚ºå¯«å…¥ Supabase æ™‚æœƒè‡ªå‹•ç”¢ç”Ÿ\nreturn [{\n  json: {\n    wrong_count: 1,\n    first_wrong_date: new Date().toISOString(),\n    last_wrong_date: new Date().toISOString(),\n    user_answers: userAnswers, // å‚³é€é™£åˆ—ï¼Œè®“å¾Œé¢çš„ Supabase ç¯€é»å­˜æˆ JSONB\n    is_reviewed: false\n  }\n}];"
      },
      "id": "13634f30-e4b2-4271-b8e1-64baea60a65e",
      "name": "æº–å‚™æ–°å¢è³‡æ–™1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        -272
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"éŒ¯é¡Œè¨˜éŒ„å·²æ›´æ–°\",\n  \"data\": {\n    \"userId\": \"{{ $('æ¥æ”¶å‰ç«¯è«‹æ±‚éŒ¯èª¤é¡Œ').first().json.body.userId }}\",\n    \"processedCount\": {{ $('æ‰¾å‡ºç­”éŒ¯çš„é¡Œç›®').all().length }},\n    \"timestamp\": \"{{ $now.toISO() }}\"\n  },\n  \"creator\": \"Nick Chang | nickleo051216@gmail.com\"\n}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "8af028c4-65dd-406f-8a67-f6ca1a66e820",
      "name": "å›å‚³æˆåŠŸè¨Šæ¯1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        640,
        -416
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "update-wrong-questions",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "6799bf11-575c-4434-bd3c-c077ebf07b5e",
      "name": "æ¥æ”¶å‰ç«¯è«‹æ±‚éŒ¯èª¤é¡Œ",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -928,
        -288
      ],
      "webhookId": "[REMOVED]"
    },
    {
      "parameters": {
        "content": "GOOGLE\n",
        "height": 464,
        "width": 2384
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -960,
        288
      ],
      "typeVersion": 1,
      "id": "db64d522-1473-4a79-ba2a-78a7ca40cd39",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "éŒ¯é¡ŒåŒæ­¥\n\n",
        "height": 464,
        "width": 1792
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1104,
        -352
      ],
      "typeVersion": 1,
      "id": "f0be780f-1ea6-425d-8e64-21a72c8b59be",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "Line ç™»å…¥ç³»çµ±\n",
        "height": 496,
        "width": 2208
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1216,
        -1408
      ],
      "typeVersion": 1,
      "id": "3bfe66da-4d68-489d-8497-d70f874c5b93",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "google-login",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -928,
        448
      ],
      "id": "65842644-2242-43fd-9791-37321e0d63a6",
      "name": "Webhook",
      "webhookId": "[REMOVED]"
    },
    {
      "parameters": {
        "url": "https://naftwmajxuoauokuwpaz.supabase.co/auth/v1/user",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.body.access_token }}"
            },
            {
              "name": "apiKey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hZnR3bWFqeHVvYXVva3V3cGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5OTgxNTgsImV4cCI6MjA3NjU3NDE1OH0.zf-eKQVC5PCFFC_ZucGNbFsc8n4627rRxZQ2A0S4FM4"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -704,
        448
      ],
      "id": "6e4ba17c-7808-4a28-bdfd-fc682af62488",
      "name": "Supabase Fetch User"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"Google ç™»å…¥æˆåŠŸ\",\n  \"Google_user_id\": \"{{ $json.Google_user_id }}\",\n  \"displayName\": \"{{ $json.displayName }}\",\n  \"email\": \"{{ $json.email }}\",\n  \"pictureUrl\": \"{{ $json.pictureUrl }}\",\n  \"member_level\": \"{{ $json.member_level }}\",\n  \"paid_until\": \"{{ $json.paid_until }}\",\n  \"register_date\": \"{{ $json.register_date }}\",\n  \"last_login\": \"{{ $json.last_login }}\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1984,
        448
      ],
      "id": "27f5879c-f91f-480f-81df-951ea92df697",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// å–å¾—ä¸Šä¸€æ­¥ (Supabase Fetch User) è¿”å›çš„ç”¨æˆ¶è³‡æ–™ç‰©ä»¶\nconst userResponse = $input.item.json;\n\n// å–å¾—ç¬¬ä¸€æ­¥ (Webhook) å‚³å…¥çš„ Token è³‡æ–™\n// æ³¨æ„ï¼šåœ¨ n8n ä¸­ï¼Œæ‚¨å¯èƒ½éœ€è¦é€é $node èªæ³•ä¾†å­˜å–åˆå§‹ Webhook çš„è³‡æ–™\n// é€™è£¡å‡è¨­æˆ‘å€‘å¯ä»¥ç›´æ¥å¾ä¸Šä¸€å€‹ç¯€é»çš„åŸå§‹è¼¸å…¥å–å¾— tokens\nconst initialData = $input.item.json; \n// ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å‡è¨­ Supabase Fetch User çš„è¼¸å‡ºå·²ç¶“åŒ…å«äº†åŸå§‹çš„ tokens\n// ä½†åœ¨å¯¦éš› n8n ä¸­ï¼Œæ‚¨å¯èƒ½éœ€è¦ç”¨ $node[\"Webhook\"].json å–å¾—\n\n// æª¢æŸ¥æ˜¯å¦æˆåŠŸå–å¾—ç”¨æˆ¶è³‡è¨Š\nif (!userResponse || !userResponse.id) {\n    // é›–ç„¶ç†è«–ä¸Š Webhook Response æ‡‰è©²æœƒè™•ç†å¤±æ•—ï¼Œä½†é€™è£¡æä¾›ä¸€å€‹å¤±æ•—é˜²è­·\n    return [{ json: { status: 'error', message: 'ç„¡æ³•å¾ Supabase å–å¾—ç”¨æˆ¶è³‡æ–™' } }];\n}\n\n// æ ¼å¼åŒ–è¦å„²å­˜åˆ° Google Sheets çš„è³‡æ–™\nconst formattedData = {\n  // å¾ Supabase çš„å›æ‡‰ä¸­å–å‡ºæ ¸å¿ƒè³‡æ–™\n  google_id: userResponse.id,\n  email: userResponse.email,\n  // å„ªå…ˆä½¿ç”¨ Supabase metadata ä¸­çš„ nameï¼Œå¦å‰‡ä½¿ç”¨ email\n  name: userResponse.user_metadata?.full_name || userResponse.email,\n  avatar_url: userResponse.user_metadata?.avatar_url || '',\n  \n  // è¨­å®šé è¨­æœƒå“¡ç­‰ç´š (å¾… Google Sheets ç¯€é»æ›´æ–°æˆ–æ–°å¢)\n  member_level: 'å…è²»æœƒå“¡', \n\n  // è¨˜éŒ„æ™‚é–“èˆ‡ token\n  login_time: new Date().toISOString(),\n  access_token: initialData.access_token, // å‡è¨­ token è¢«å¸¶éä¾†\n  refresh_token: initialData.refresh_token, // å‡è¨­ token è¢«å¸¶éä¾†\n  created_at: new Date().toISOString()\n};\n\nreturn [{ json: formattedData }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        448
      ],
      "id": "795b19e4-0532-4c96-a376-417f754fd8ab",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "// ç¢ºä¿æ­¤ç¯€é»çš„è¼¸å…¥æ˜¯ä¾†è‡ª Google Sheets (Update or Append) çš„è¼¸å‡º\n\nconst sheetOutput = $input.item.json;\n\n// æå–ç¬¬ä¸€å€‹æˆåŠŸçš„çµæœ\nconst finalUser = sheetOutput[0] || sheetOutput; \n\n// æª¢æŸ¥æ˜¯å¦æˆåŠŸå–å¾—æœƒå“¡è³‡æ–™\nif (!finalUser || !finalUser.google_id) {\n  // å¦‚æœ Google Sheets è™•ç†å¤±æ•—ï¼Œè¿”å›éŒ¯èª¤è¨Šæ¯\n  return [{ \n    json: { \n      status: 'error', \n      message: 'æœƒå“¡è³‡æ–™å­˜å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Google Sheets ç¯€é»è¨­ç½®ã€‚',\n      user_data: {}\n    } \n  }];\n}\n\n// çµ„è£æœ€çµ‚å›å‚³çµ¦å‰ç«¯ (google-callback.html) çš„ JSON çµæ§‹\nconst response = {\n  status: \"success\",\n  message: \"Google ç™»å…¥èˆ‡è³‡æ–™åŒæ­¥æˆåŠŸï¼\",\n  // æ³¨æ„ï¼šé€™è£¡å‡è¨­éä»˜è²»æœƒå“¡éœ€è¦ä»˜è²»é€šçŸ¥ï¼Œå¯¦éš›é‚è¼¯è«‹åœ¨æª¢æŸ¥æœƒå“¡ç­‰ç´šç¯€é»ä¸­å¯¦ç¾\n  needPayment: finalUser.member_level === 'ä»˜è²»æœƒå“¡' ? false : true, \n  paymentUrl: \"https://portaly.cc/zn.studio\", \n  \n  // é€™æ˜¯å‰ç«¯ <script> å€å¡Šä¸­ data.user_data é æœŸæ¥æ”¶çš„çµæ§‹\n  user_data: { \n    google_id: finalUser.google_id,\n    email: finalUser.email,\n    // ã€ä¿®æ­£é» 1ã€‘ä½¿ç”¨ Google Sheets è¼¸å‡ºçš„ \"full_name\"\n    name: finalUser.full_name || finalUser.email, \n    avatar: finalUser.picture || '',  // ç¢ºä¿é€™è£¡æœ‰å€¼\n    pictureUrl: finalUser.picture || '',  // åŒæ™‚æä¾› pictureUrl ä»¥å…¼å®¹\n    member_level: finalUser.member_level || 'å…è²»æœƒå“¡',\n    login_type: \"google\" // å³ä½¿æ˜¯ Line è¨˜éŒ„è¢«åˆä½µï¼Œæœ¬æ¬¡ç™»å…¥æ–¹å¼ä»ç‚º Google\n  }\n};\n\nreturn [{ json: response }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -32,
        448
      ],
      "id": "f8ef24c6-9586-4123-a58a-58a8d6bef937",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g",
          "mode": "list",
          "cachedResultName": "ç¤¾ç¾¤iPAS é¡Œåº«",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1350648105,
          "mode": "list",
          "cachedResultName": "ã€Œæœƒå“¡è³‡æ–™ã€(GOOGLE)",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FvOxZb46ek8N2kSH4QvVsS21IGKCqk-wr7WBljBve8g/edit#gid=1350648105"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "google_id": "={{ $json.google_id }}",
            "full_name": "={{ $json.name }}",
            "member_level": "={{ $json.member_level }}",
            "email": "={{ $json.email }}",
            "picture": "={{ $json.avatar_url }}",
            "register_date": "={{ $today.format('yyyy-MM-dd') }}",
            "last_sign_in_at": "={{ $json.login_time }}"
          },
          "matchingColumns": [
            "google_id"
          ],
          "schema": [
            {
              "id": "google_id",
              "displayName": "google_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "full_name",
              "displayName": "full_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "member_level",
              "displayName": "member_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paid_until",
              "displayName": "paid_until",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "picture",
              "displayName": "picture",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "register_date",
              "displayName": "register_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_sign_in_at",
              "displayName": "last_sign_in_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -256,
        448
      ],
      "id": "a90a4d94-0e91-4d13-964a-9cb509cdcf7e",
      "name": "Append or update row in sheet",
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.user_data.avatar }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        416,
        368
      ],
      "id": "78bb1461-3950-48bb-8433-140f11f9d2af",
      "name": "HTTP Request",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://naftwmajxuoauokuwpaz.supabase.co/storage/v1/object/ipas/google/{{ $json.user_data.google_id }}.jpeg",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hZnR3bWFqeHVvYXVva3V3cGF6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDk5ODE1OCwiZXhwIjoyMDc2NTc0MTU4fQ.IQTvWiOuWuozhHLeXQ4M7K4rxNWFzVNl-dnTDdiJnQE"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        640,
        304
      ],
      "id": "12bc9f6b-162e-4bbe-adca-e6bcae0b50f6",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "jsCode": "// åœ¨ Code in JavaScript4 ç¯€é» (å°‡æ­¤ä»£ç¢¼å®Œæ•´è²¼å…¥)\n\n// ----------------------------------------------------------------------\n// ğŸ’¡ ç¢ºä¿é€™äº›å€¼èˆ‡æ‚¨çš„ Supabase è¨­å®šä¸€è‡´\nconst PROJECT_ID = 'naftwmajxuoauokuwpaz'; \nconst BUCKET_NAME = 'ipas'; \n// ----------------------------------------------------------------------\n\n\n// ğŸ¯ ä¿®æ­£é» 1ï¼šå®‰å…¨åœ°ç²å–åŸå§‹å›æ‡‰çµæ§‹ (Code in JavaScript3)\n// ç¢ºä¿æ‚¨æµç¨‹ä¸­çš„ç¯€é»åç¨±æ˜¯ 'Code in JavaScript3'\n// é€™æ˜¯åŒ…å« status, message, needPayment, user_data çš„å®Œæ•´çµæ§‹\nconst originalResponse = $('Code in JavaScript3').first().json.user_data; \nconst originalUserData = $('Code in JavaScript3').first().json.user_data; \n\n\n// ğŸ¯ ä¿®æ­£é» 2ï¼šå®‰å…¨åœ°ç²å–ä¸Šå‚³ Keyï¼ˆä¾†è‡ª HTTP Request2ï¼‰\n// ç¢ºä¿æ‚¨æµç¨‹ä¸­çš„ç¯€é»åç¨±æ˜¯ 'HTTP Request2'\nconst uploadResponse = $input.first().json.Key; \n\n// ä¸Šå‚³æˆåŠŸçš„å›æ‡‰ Key (ipas/google/Studio ZN.jpeg)\nconst uploadResponseKey = $input.first().json.Key; \n\nif (!originalUserData) {\n    throw new Error('æµç¨‹éŒ¯èª¤ï¼šåŸå§‹å›æ‡‰ä¸­ç¼ºå°‘ user_data çµæ§‹ã€‚');\n}\nif (!uploadResponseKey) {\n    throw new Error('ä¸Šå‚³ Key ç²å–å¤±æ•—ã€‚è«‹æª¢æŸ¥ HTTP Request2 ç¯€é»è¼¸å‡ºã€‚');\n}\n\n\n// 3. çµ„è£å…¬é–‹ç¶²å€ (Public URL)\n// ç¶²å€æ ¼å¼: https://[PROJECT_ID].supabase.co/storage/v1/object/public/[BUCKET_NAME]/[FILE_PATH]\nconst publicUrl = `https://${PROJECT_ID}.supabase.co/storage/v1/object/public/${uploadResponseKey}`;\n\n\n// 4. æ›´æ–° user_data çµæ§‹ (å•é¡Œè¡Œæ•¸å·²ä¿®æ­£ï¼)\noriginalUserData.avatar = publicUrl;\noriginalUserData.pictureUrl = publicUrl;\n\n\n// 5. è¿”å›æ›´æ–°å¾Œçš„å®Œæ•´è³‡æ–™çµæ§‹\nreturn [{ \n    json: { \n        ...originalResponse, // ä¿ç•™æ‰€æœ‰ status, message, paymentUrl ç­‰é ‚å±¤å±¬æ€§\n        user_data: originalUserData // æ›¿æ›ç‚ºåŒ…å«æ–°ç¶²å€çš„ user_data\n    } \n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        864,
        304
      ],
      "id": "23797410-daec-420f-a5c2-501f621a2f89",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "google_user",
        "filters": {
          "conditions": [
            {
              "keyName": "Google_user_id",
              "condition": "eq",
              "keyValue": "={{ $json.google_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "pictureUrl",
              "fieldValue": "={{ $json.pictureUrl }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -928,
        816
      ],
      "id": "62ed6180-3b40-4eb7-99f3-a3743980c5e1",
      "name": "Update a row",
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "google_user",
        "filters": {
          "conditions": [
            {
              "keyName": "displayName",
              "keyValue": "={{ $json.user_data.name }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1088,
        448
      ],
      "id": "df8eda13-ba4d-49f9-bbf9-73cea1ad9184",
      "name": "Get a row1",
      "alwaysOutputData": true,
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f1075cf2-04c2-4f77-8d5d-4205c4141e43",
              "leftValue": "={{ $json.displayName }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1312,
        448
      ],
      "id": "8d2aa74c-938f-4f7c-a88c-6e9d183ffedc",
      "name": "æœ‰æ²’æœ‰ç™»å…¥é(æ²’æœ‰çš„è©±)"
    },
    {
      "parameters": {
        "content": "âœ… åˆ¤æ–·ç”¨æˆ¶æ˜¯å¦ç‚ºä»˜è²»æœƒå“¡\nâœ… æ§åˆ¶åŠŸèƒ½é¡¯ç¤º/éš±è—\nâœ… æ±ºå®šä½•æ™‚é¡¯ç¤ºå‡ç´šæŒ‰éˆ•",
        "height": 320,
        "width": 1248
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1056,
        -1744
      ],
      "typeVersion": 1,
      "id": "05e91d5f-e359-4de4-aab8-85b09c207c18",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -240,
        -240
      ],
      "id": "069549d8-d575-4d3f-acdd-3e61b049e3a8",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "tableId": "users",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.google_id }}"
            },
            {
              "fieldId": "displayName",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.full_name }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.email }}"
            },
            {
              "fieldId": "pictureUrl",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.picture }}"
            },
            {
              "fieldId": "member_level",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.member_level }}"
            },
            {
              "fieldId": "register_date",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.register_date }}"
            },
            {
              "fieldId": "last_login",
              "fieldValue": "={{$now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1760,
        352
      ],
      "id": "25677ad3-38bf-45f7-b462-cfd78167632a",
      "name": "æ–°å¢åˆ° User",
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "tableId": "google_user",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "Google_user_id",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.google_id }}"
            },
            {
              "fieldId": "displayName",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.full_name }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.email }}"
            },
            {
              "fieldId": "member_level",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.member_level }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.register_date }}"
            },
            {
              "fieldId": "last_login",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.last_sign_in_at }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1536,
        352
      ],
      "id": "01cb7073-5d94-4d2e-967a-8b4d4df0c88e",
      "name": "æ–°å¢åˆ° google User",
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "80771c95-b84b-4e0c-8f1d-5c55b6c6f2ea",
              "leftValue": "={{ $json.user_data.avatar }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        192,
        448
      ],
      "id": "f901dab7-66d7-4cc0-8b0d-42e508049905",
      "name": "æœ‰æ”¾å¤§é ­è²¼"
    },
    {
      "parameters": {
        "jsCode": "// å–å¾— Code in JavaScript3 è¼¸å‡ºçš„è³‡æ–™\nconst userData = $input.item.json;\n\n// ğŸ¯ è¨­å®š pictureUrl ç‚ºç©ºå­—ä¸²\n// é€™æ¨£å®ƒå°±æœƒå‘ä¸‹å‚³éç©ºå­—ä¸²çµ¦ Supabase æ›´æ–°ç¯€é»\nuserData.pictureUrl = \"\"; \nuserData.user_data.pictureUrl = \"\"; // æ›´æ–° user_data çµæ§‹ä¸­çš„ pictureUrl\n\n// ä¿æŒ user_data.avatar ä¹Ÿç‚ºç©ºï¼Œé›–ç„¶é€™å€‹æ¬„ä½å¯èƒ½å·²ç¶“æ˜¯ç©ºçš„\nuserData.user_data.avatar = \"\"; \n\n// è¿”å›æ›´æ–°å¾Œçš„è³‡æ–™ï¼Œå°‡å…¶å‚³éçµ¦ Supabase æ›´æ–°è³‡æ–™åº«çš„ç¯€é»\nreturn [{ json: userData }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        864,
        592
      ],
      "id": "16bdf0e8-39ab-4ad3-9773-7895cdda7254",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "google_user",
        "filters": {
          "conditions": [
            {
              "keyName": "Google_user_id",
              "condition": "eq",
              "keyValue": "={{ $json.Google_user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "Google_user_id",
              "fieldValue": "={{ $json.google_id }}"
            },
            {
              "fieldId": "displayName",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.full_name }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.email }}"
            },
            {
              "fieldId": "member_level",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.member_level }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.register_date }}"
            },
            {
              "fieldId": "last_login",
              "fieldValue": "={{ $('Append or update row in sheet').item.json.last_sign_in_at }}"
            },
            {
              "fieldId": "pictureUrl",
              "fieldValue": "={{ $json.user_data.pictureUrl }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1760,
        544
      ],
      "id": "834774f4-1852-43b7-8e49-c6c683908681",
      "name": "æ›´æ–° google User",
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "users",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.line_user_id }}"
            },
            {
              "fieldId": "displayName",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.displayName }}"
            },
            {
              "fieldId": "member_level",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.member_level }}"
            },
            {
              "fieldId": "pictureUrl",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.pictureUrl }}"
            },
            {
              "fieldId": "register_date",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.register_date }}"
            },
            {
              "fieldId": "last_login",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $json.created_at }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        672,
        -1296
      ],
      "id": "1b12e669-ed1d-4eea-bef2-a2b2675060b7",
      "name": "æ›´æ–°èˆŠæœƒå“¡è³‡æ–™",
      "credentials": "[REMOVED]"
    },
    {
      "parameters": {
        "tableId": "users",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.line_user_id }}"
            },
            {
              "fieldId": "displayName",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.displayName }}"
            },
            {
              "fieldId": "member_level",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.member_level }}"
            },
            {
              "fieldId": "pictureUrl",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.pictureUrl }}"
            },
            {
              "fieldId": "register_date",
              "fieldValue": "={{ $('è™•ç†ç”¨æˆ¶è³‡æ–™').item.json.register_date }}"
            },
            {
              "fieldId": "last_login",
              "fieldValue": "={{ $now }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        672,
        -1440
      ],
      "id": "d0172dd7-06cd-4727-a04d-69391a83249c",
      "name": "æ–°å¢æ–°æœƒå“¡",
      "credentials": "[REMOVED]"
    }
  ],
  "connections": {
    "Webhook1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ¥æ”¶ Webhook": {
      "main": [
        [
          {
            "node": "æª¢æŸ¥æ˜¯å¦ç‚º OPTIONS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æª¢æŸ¥æ˜¯å¦ç‚º OPTIONS": {
      "main": [
        [
          {
            "node": "å›æ‡‰ OPTIONS (CORS Preflight)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å…Œæ› Access Token1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—ç”¨æˆ¶è³‡æ–™": {
      "main": [
        [
          {
            "node": "è™•ç†ç”¨æˆ¶è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è™•ç†ç”¨æˆ¶è³‡æ–™": {
      "main": [
        [
          {
            "node": "Get a row",
            "type": "main",
            "index": 0
          },
          {
            "node": "å„²å­˜åˆ° Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å„²å­˜åˆ° Google Sheets": {
      "main": [
        [
          {
            "node": "æª¢æŸ¥æœƒå“¡ç­‰ç´š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æª¢æŸ¥æœƒå“¡ç­‰ç´š": {
      "main": [
        [
          {
            "node": "å›æ‡‰ï¼šä»˜è²»æœƒå“¡",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å›æ‡‰ï¼šä¸€èˆ¬æœƒå“¡ï¼ˆéœ€ä»˜è²»ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å…Œæ› Access Token1": {
      "main": [
        [
          {
            "node": "å–å¾—ç”¨æˆ¶è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ¥æ”¶å‰ç«¯è«‹æ±‚": {
      "main": [
        [
          {
            "node": "è™•ç†è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è™•ç†è³‡æ–™": {
      "main": [
        [
          {
            "node": "å„²å­˜åˆ° practice_records",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å„²å­˜åˆ° practice_records": {
      "main": [
        [
          {
            "node": "æº–å‚™æŸ¥è©¢æ¢ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æº–å‚™æŸ¥è©¢æ¢ä»¶": {
      "main": [
        [
          {
            "node": "æŸ¥è©¢ä»Šæ—¥ä½¿ç”¨é‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è©¢ä»Šæ—¥ä½¿ç”¨é‡": {
      "main": [
        [
          {
            "node": "åˆ¤æ–·æ˜¯å¦æœ‰è¨˜éŒ„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–·æ˜¯å¦æœ‰è¨˜éŒ„": {
      "main": [
        [
          {
            "node": "æº–å‚™æ›´æ–°è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æº–å‚™æ–°å¢è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æº–å‚™æ›´æ–°è³‡æ–™": {
      "main": [
        [
          {
            "node": "æ›´æ–°æ¯æ—¥ä½¿ç”¨é‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°æ¯æ—¥ä½¿ç”¨é‡": {
      "main": [
        [
          {
            "node": "å›å‚³æˆåŠŸè¨Šæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æº–å‚™æ–°å¢è³‡æ–™": {
      "main": [
        [
          {
            "node": "æ–°å¢æ¯æ—¥ä½¿ç”¨é‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ–°å¢æ¯æ—¥ä½¿ç”¨é‡": {
      "main": [
        [
          {
            "node": "å›å‚³æˆåŠŸè¨Šæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a row": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "æ–°å¢æ–°æœƒå“¡",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ›´æ–°èˆŠæœƒå“¡è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‰¾å‡ºç­”éŒ¯çš„é¡Œç›®": {
      "main": [
        [
          {
            "node": "åˆ¤æ–·: æ˜¯å¦æœ‰éŒ¯é¡Œ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–·: æ˜¯å¦æœ‰éŒ¯é¡Œ?": {
      "main": [
        [
          {
            "node": "å›æ‡‰: æ²’æœ‰éŒ¯é¡Œ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è©¢è©²éŒ¯é¡Œæ˜¯å¦å·²å­˜åœ¨": {
      "main": [
        [
          {
            "node": "åˆ¤æ–·: éŒ¯é¡Œæ˜¯å¦å·²å­˜åœ¨?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–·: éŒ¯é¡Œæ˜¯å¦å·²å­˜åœ¨?": {
      "main": [
        [
          {
            "node": "æº–å‚™æ–°å¢è³‡æ–™1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æº–å‚™æ›´æ–°è³‡æ–™1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°ç¾æœ‰éŒ¯é¡Œ": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ–°å¢éŒ¯é¡Œè¨˜éŒ„": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æº–å‚™æ›´æ–°è³‡æ–™1": {
      "main": [
        [
          {
            "node": "æ›´æ–°ç¾æœ‰éŒ¯é¡Œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æº–å‚™æ–°å¢è³‡æ–™1": {
      "main": [
        [
          {
            "node": "æ–°å¢éŒ¯é¡Œè¨˜éŒ„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ¥æ”¶å‰ç«¯è«‹æ±‚éŒ¯èª¤é¡Œ": {
      "main": [
        [
          {
            "node": "æ‰¾å‡ºç­”éŒ¯çš„é¡Œç›®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Supabase Fetch User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Fetch User": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Append or update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "æœ‰æ”¾å¤§é ­è²¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Get a row1",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript4": {
      "main": [
        [
          {
            "node": "Get a row1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update a row": {
      "main": [
        []
      ]
    },
    "Get a row1": {
      "main": [
        [
          {
            "node": "æœ‰æ²’æœ‰ç™»å…¥é(æ²’æœ‰çš„è©±)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœ‰æ²’æœ‰ç™»å…¥é(æ²’æœ‰çš„è©±)": {
      "main": [
        [
          {
            "node": "æ–°å¢åˆ° google User",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ›´æ–° google User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "å›å‚³æˆåŠŸè¨Šæ¯1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æŸ¥è©¢è©²éŒ¯é¡Œæ˜¯å¦å·²å­˜åœ¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ–°å¢åˆ° google User": {
      "main": [
        [
          {
            "node": "æ–°å¢åˆ° User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ–°å¢åˆ° User": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœ‰æ”¾å¤§é ­è²¼": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "Get a row1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–° google User": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "nickleo9.zeabur.app",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36",
            "content-length": "1369",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7",
            "content-type": "application/json",
            "origin": "https://nickleo9.github.io",
            "priority": "u=1, i",
            "referer": "https://nickleo9.github.io/",
            "sec-ch-ua": "\"Chromium\";v=\"142\", \"Google Chrome\";v=\"142\", \"Not_A Brand\";v=\"99\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "61.70.198.205, 61.70.198.205",
            "x-forwarded-host": "nickleo9.zeabur.app",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-real-ip": "61.70.198.205",
            "x-zeabur-container-port": "5678",
            "x-zeabur-ip-country": "TW",
            "x-zeabur-request-id": "hnd1::55ccd9c2-6973-4525-aa08-77a334fe8cb1"
          },
          "params": {},
          "query": {},
          "body": {
            "access_token": "eyJhbGciOiJIUzI1NiIsImtpZCI6IlUxQXN3L0FtUW4vRXFrajEiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL25hZnR3bWFqeHVvYXVva3V3cGF6LnN1cGFiYXNlLmNvL2F1dGgvdjEiLCJzdWIiOiIyNmViMjE2OS1jMGQ2LTQxYzQtYmM4Zi0zMmFiYTBlZDg3OGMiLCJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzYzNTE1OTcwLCJpYXQiOjE3NjM1MTIzNzAsImVtYWlsIjoibmlja2xlbzNAZ21haWwuY29tIiwicGhvbmUiOiIiLCJhcHBfbWV0YWRhdGEiOnsicHJvdmlkZXIiOiJnb29nbGUiLCJwcm92aWRlcnMiOlsiZ29vZ2xlIl19LCJ1c2VyX21ldGFkYXRhIjp7ImF2YXRhcl91cmwiOiJodHRwczovL2xoMy5nb29nbGV1c2VyY29udGVudC5jb20vYS9BQ2c4b2NKck01M0VYNFFWV1BHM0hSWTNUdmxMVnFtaEFmUFVkUGZkcFVjUmJQY0oxMmxlRDZZd0ZnPXM5Ni1jIiwiZW1haWwiOiJuaWNrbGVvM0BnbWFpbC5jb20iLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiZnVsbF9uYW1lIjoi5by15oOf6I2PIiwiaXNzIjoiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tIiwibmFtZSI6IuW8teaDn-iNjyIsInBob25lX3ZlcmlmaWVkIjpmYWxzZSwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0pyTTUzRVg0UVZXUEczSFJZM1R2bExWcW1oQWZQVWRQZmRwVWNSYlBjSjEybGVENll3Rmc9czk2LWMiLCJwcm92aWRlcl9pZCI6IjEwMTYzMTM5Mzg1MDI1MjA3MDQxOSIsInN1YiI6IjEwMTYzMTM5Mzg1MDI1MjA3MDQxOSJ9LCJyb2xlIjoiYXV0aGVudGljYXRlZCIsImFhbCI6ImFhbDEiLCJhbXIiOlt7Im1ldGhvZCI6Im9hdXRoIiwidGltZXN0YW1wIjoxNzYzNTEyMzcwfV0sInNlc3Npb25faWQiOiI2ZWFhYWRhOC03MjQyLTQ2YWYtOGRhMi1mYWMzNTFkZmQwNmUiLCJpc19hbm9ueW1vdXMiOmZhbHNlfQ.X0jlAEg9SAHu43aYHW0Hz_zl2veEe-ndYUJhmx3fgIg",
            "refresh_token": "t32rz6uglviy",
            "login_type": "google"
          },
          "webhookUrl": "https://nickleo9.zeabur.app/webhook/google-login",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "223f2c0b-2788-46e1-a95a-4851faed9f98",
  "triggerCount": 5,
  "shared": [
    {
      "updatedAt": "2025-10-02T05:11:58.384Z",
      "createdAt": "2025-10-02T05:11:58.384Z",
      "role": "workflow:owner",
      "workflowId": "JsBZeDAkcXgYiLYF",
      "projectId": "4W71QCd0cKKsiKSS"
    }
  ],
  "tags": []
}